<div class="modal" tabindex="-1" [ngStyle]="{'display':displayStyle}" role="dialog">
  <div class="modal-dialog modal-centered modal-xl">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title w-100 text-center">
          {{mode | titlecase}} Unit {{mode === 'delete' ? '' : 'Schedule'}}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" (click)="onCancel()">
        </button>
      </div>

      <ng-container *ngIf="mode !== 'delete'">
        <div class="modal-body">
          <form [formGroup]="form" #f="ngForm" [ngClass]="{'is-submitted': f.submitted}" id="form">

            <table class="table table-hover text-center">
              <thead>
                <tr>
                  <th>Total</th>
                  <th>{{totalUnits | number: '1.0-0' : 'en-GB'}}</th>
                  <th>{{totalAreaSize | number: '1.2-2' : 'en-GB'}}</th>
                  <th *ngIf="unitStructure.hasBeds()">{{totalBeds | number: '1.0-0' : 'en-GB'}}</th>

                  <ng-container *ngIf="assetClass.investmentStrategy === 'buildToSell'">
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                  </ng-container>

                  <ng-container *ngIf="assetClass.investmentStrategy === 'buildToRent'">
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                  </ng-container>
                </tr>

                <tr>
                  <th>{{unitStructure.label | titlecase}}</th>
                  <th class="column-description">Description</th>
                  <th>{{unitStructure.areaType}} ({{unitStructure.areaSystem}})</th>
                  <th *ngIf="unitStructure.hasBeds()">Beds</th>

                  <ng-container *ngIf="assetClass.investmentStrategy === 'buildToSell'">
                    <th>Target price</th>
                    <th>Price achieved</th>
                    <th class="column-status">Sale status</th>
                    <th>Status update</th>
                    <th>Buyer</th>
                  </ng-container>

                  <ng-container *ngIf="assetClass.investmentStrategy === 'buildToRent'">
                    <th>Rent</th>
                    <th>Lease start</th>
                    <th>Duration</th>
                    <th>Tenant</th>
                  </ng-container>

                  <th class="text-invisible" style="width: 20px"> &times;</th>
                </tr>
              </thead>
              <tbody formArrayName="units">
                <tr *ngFor='let unit of units.controls; let i = index' [formGroupName]="i">
                  <td>
                    <input class="form-control text-center" formControlName="identifier" placeholder="identifier">
                  </td>
                  <td>
                    <input class="form-control text-center" formControlName="description" placeholder="description">
                  </td>
                  <td>
                    <input class="form-control text-center" formControlName="areaSize" placeholder="1">
                  </td>
                  <td *ngIf="unitStructure.hasBeds()">
                    <input class="form-control text-center" formControlName="beds" placeholder="1">
                  </td>

                  <ng-container *ngIf="assetClass.investmentStrategy === 'buildToSell'">
                    <td>
                      <input class="form-control text-center" formControlName="salePriceTarget" placeholder="0">
                    </td>
                    <td>
                      <input class="form-control text-center" formControlName="salePriceAchieved"
                        placeholder="available">
                    </td>
                    <td class="px-2">
                      <select class="form-select px-2" id="saleStatus" formControlName="saleStatus"
                        [compareWith]="compareFn">
                        <option *ngFor='let status of saleStatusChoices' [ngValue]="status.value">{{status.label}}
                        </option>
                      </select>
                    </td>
                    <td>
                      <input class="form-control text-center" formControlName="saleStatusDate" placeholder="DD/MM/YY"
                        bsDatepicker>
                    </td>
                    <td>
                      <input class="form-control text-center" formControlName="saleBuyer" placeholder="available">
                    </td>
                  </ng-container>

                  <ng-container *ngIf="assetClass.investmentStrategy === 'buildToRent'">
                    <td>
                      <input class="form-control text-center" formControlName="leaseRentAmount" placeholder="0">
                      {{unit.get('leaseRentAmount') ? rentFrequency: ""}}
                    </td>
                    <td>
                      <input class="form-control text-center" formControlName="leaseStartDate" placeholder="DD/MM/YY"
                        bsDatepicker>
                    </td>
                    <td>
                      <input class="form-control text-center" formControlName="leaseDuration" placeholder="1">
                      {{unit.get('leaseDuration') ? leaseFrequency: ""}}
                    </td>
                    <td>
                      <input class="form-control text-center" formControlName="leaseTenant" placeholder="available">
                    </td>
                  </ng-container>

                  <td style="width: 20px">
                    <span class="deleteHover cursorPointer text-red rounded" (click)="onConfirmDelete(i)">&times;</span>
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="mt-3">
              <button type="button" class="btn btn-primary" (click)="onAddUnit()">Add Unit</button>

              <div *ngIf="f.submitted && f.invalid" class="mt-1 border border-danger rounded">
                <div class="d-flex justify-content-center">
                  <ul class="m-1">
                    <li *ngFor="let errorMessage of getFormArrayErrorMessages(units)" class="text-danger">
                      {{ errorMessage }}
                    </li>
                  </ul>
                </div>
              </div>
            </div>

          </form>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary m-2" (click)="onCancel()">Cancel</button>
          <button form="form" type="submit" class="btn btn-success m-2" (click)="onSave()">Save</button>
        </div>
      </ng-container>

      <ng-container *ngIf="mode === 'delete'">
        <div class="modal-body">
          <p class="text-center my-auto">Are you sure you want to delete this unit?</p>
        </div>

        <div class="table">
          <div class="table-row header text-center">
            <div class="table-cell-header pt-2">{{unitStructure.label | titlecase}}</div>
            <div class="table-cell-header pt-2">Description</div>
            <div class="table-cell-header pt-2v">{{unitStructure.areaType}} ({{unitStructure.areaSystem}})</div>
            <div class="table-cell-header pt-2" *ngIf="unitStructure.hasBeds()">Beds</div>

            <ng-container *ngIf="assetClass.investmentStrategy === 'buildToSell'">
              <div class="table-cell-header pt-2">Sold price</div>
              <div class="table-cell-header pt-2">Buyer</div>
            </ng-container>

            <ng-container *ngIf="assetClass.investmentStrategy === 'buildToRent'">
              <div class="table-cell-header pt-2">Lease start</div>
              <div class="table-cell-header pt-2">Duration</div>
              <div class="table-cell-header pt-2">Rent</div>
              <div class="table-cell-header pt-2">Tenant</div>
            </ng-container>

            <div class="table-cell text-invisible" style="width: 20px"> &times;</div>
          </div>

          <div class="table-row">
            <div class="table-cell text-center">
              {{!!units.at(index).get('identifier')?.value ? units.at(index).get('identifier')?.value: 'not defined'}}
            </div>
            <div class="table-cell text-center">
              {{!!units.at(index).get('description')?.value ? units.at(index).get('description')?.value: 'not defined'}}
            </div>
            <div class="table-cell text-center">
              {{!!units.at(index).get('areaSize')?.value ? units.at(index).get('areaSize')?.value: 'not defined'}}
            </div>
            <div class="table-cell text-center" *ngIf="unitStructure.hasBeds()">
              {{!!units.at(index).get('beds')?.value ? units.at(index).get('beds')?.value: 'not defined'}}
            </div>

            <ng-container *ngIf="assetClass.investmentStrategy === 'buildToSell'">
              <div class="table-cell text-center">
                {{!!units.at(index).get('salePrice')?.value ? units.at(index).get('salePrice')?.value: 'not defined'}}
              </div>
              <div class="table-cell text-center">
                {{!!units.at(index).get('saleBuyer')?.value ? units.at(index).get('saleBuyer')?.value: 'not defined'}}
              </div>
            </ng-container>

            <ng-container *ngIf="assetClass.investmentStrategy === 'buildToRent'">
              <div class="table-cell text-center">
                {{!!units.at(index).get('leaseStartDate')?.value ? units.at(index).get('leaseStartDate')?.value: 'not defined'}}
              </div>
              <div class="table-cell text-center">
                <ng-container
                  *ngIf="units.at(index).get('leaseDuration')?.value as leaseDuration; else leaseNotDefined">
                  {{leaseDuration}} {{leaseFrequency}}
                </ng-container>
                <ng-template #leaseNotDefined>not defined</ng-template>
              </div>
              <div class="table-cell text-center">
                <ng-container *ngIf="units.at(index).get('leaseRentAmount')?.value as rentValue; else rentNotDefined">
                  {{rentValue}} {{rentFrequency}}
                </ng-container>
                <ng-template #rentNotDefined>not defined</ng-template>
              </div>
              <div class="table-cell text-center">
                {{units.at(index).get('leaseTenant')?.value}}
              </div>
            </ng-container>

            <div class="table-cell align-middle" style="width: 20px">
              <span class="text-invisible">&times;</span></div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary m-2" (click)="onCancelDelete()">Cancel</button>
          <button type="submit" class="btn btn-danger m-2" (click)="onRemoveUnit()">Delete</button>
        </div>
      </ng-container>

    </div>
  </div>
</div>
